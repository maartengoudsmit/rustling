---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = await getCollection('posts', ({ data }) => !data.draft);
const notes = await getCollection('notes');

// Combine into a unified timeline
type TimelineItem =
  | { type: 'post'; data: typeof posts[number] }
  | { type: 'note'; data: typeof notes[number] };

const timeline: TimelineItem[] = [
  ...posts.map(post => ({ type: 'post' as const, data: post })),
  ...notes.map(note => ({ type: 'note' as const, data: note })),
].sort((a, b) => b.data.data.pubDate.valueOf() - a.data.data.pubDate.valueOf());

const formatDate = (date: Date) => date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
});
---

<BaseLayout>
  <ul class="timeline">
    {timeline.map(async (item) => {
      if (item.type === 'note') {
        const { Content } = await render(item.data);
        return (
          <li class="timeline-item note">
            <div class="note-content">
              <Content />
            </div>
            <footer class="item-meta">
              <time datetime={item.data.data.pubDate.toISOString()}>
                {formatDate(item.data.data.pubDate)}
              </time>
              <a href={`/notes/${item.data.id}`}>permalink</a>
              {item.data.data.tags.length > 0 && (
                <span class="tags">
                  {item.data.data.tags.map((tag: string) => <span class="tag">#{tag}</span>)}
                </span>
              )}
            </footer>
          </li>
        );
      } else {
        return (
          <li class="timeline-item post">
            <a href={`/posts/${item.data.id}`} class="post-link">
              <span class="post-title">{item.data.data.title}</span>
              <span class="post-description">{item.data.data.description}</span>
              <span class="read-more">Read article <span class="arrow">â†’</span></span>
            </a>
            <time class="post-date" datetime={item.data.data.pubDate.toISOString()}>
              {formatDate(item.data.data.pubDate)}
            </time>
          </li>
        );
      }
    })}
  </ul>
</BaseLayout>

<style>

  .timeline {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .timeline-item {
    padding: 1.25rem;
    border-radius: var(--radius-md);
    transition: box-shadow var(--transition), transform var(--transition);
  }

  /* Posts - left border style */
  .timeline-item.post {
    background: transparent;
    border-left: 3px solid var(--color-post);
    padding-left: 1.25rem;
    border-radius: 0;
  }

  .timeline-item.post:hover {
    background: rgba(90, 125, 90, 0.04);
  }

  /* Notes - card style */
  .timeline-item.note {
    background: var(--color-bg-secondary);
    border-left: 3px solid var(--color-note);
    box-shadow: var(--shadow-sm);
  }

  .timeline-item.note:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  /* Notes */
  .note-content {
    line-height: 1.7;
  }

  .note-content :global(p) {
    margin-bottom: 0.5rem;
  }

  .note-content :global(p:last-child) {
    margin-bottom: 0;
  }

  /* Posts */
  .post-link {
    display: block;
  }

  .post-title {
    display: block;
    font-family: var(--font-heading);
    font-weight: 500;
    font-size: var(--text-xl);
    color: var(--color-text);
    transition: color var(--transition);
  }

  .post-link:hover .post-title {
    color: var(--color-accent);
  }

  .post-description {
    display: block;
    color: var(--color-text-secondary);
    font-size: var(--text-base);
    margin-top: 0.25rem;
    line-height: 1.5;
  }

  .read-more {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    margin-top: 0.75rem;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-accent);
  }

  .read-more .arrow {
    transition: transform var(--transition);
  }

  .post-link:hover .read-more .arrow {
    transform: translateX(3px);
  }

  .post-date {
    display: block;
    margin-top: 0.5rem;
    font-size: var(--text-sm);
    color: var(--color-muted);
  }

  /* Note meta */
  .item-meta {
    margin-top: 0.75rem;
    font-size: var(--text-sm);
    color: var(--color-muted);
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .item-meta a {
    color: var(--color-muted);
  }

  .item-meta a:hover {
    color: var(--color-accent);
  }

  .tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag {
    background: rgba(45, 106, 79, 0.12);
    color: var(--color-accent);
    padding: 0.15rem 0.6rem;
    border-radius: 9999px;
    font-size: var(--text-xs);
    font-weight: 500;
    transition: background var(--transition);
  }

  .tag:hover {
    background: rgba(45, 106, 79, 0.2);
  }
</style>
